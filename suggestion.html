<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Find a relevant taxon by scientific, taxon rank or common name</title>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"/>
    <script src="globi-dist.js" charset="utf-8"></script>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
    <script>
        $(function () {

            var labelForTaxon = function (taxon) {
                var englishName;
                if (taxon.commonNames) {
                    taxon.commonNames.forEach(function (element) {
                        if (element.lang === 'en') {
                            englishName = element.name;
                        }
                    });
                }
                var suggestion = taxon.scientificName;
                if (englishName !== undefined) {
                    suggestion = englishName + ' (' + suggestion + ')';
                }
                return suggestion;
            };

            $(".tags").autocomplete({
                minLength: 3,
                source: function (request, response) {
                    globi.globiData.findCloseTaxonMatches(request.term, function (closeMatches) {
                        var suggestions = [];
                        closeMatches.forEach(function (closeMatch, index) {
                            suggestions[index] = {
                                label: labelForTaxon(closeMatch),
                                value: closeMatch.scientificName
                            };
                        });
                        response(suggestions);
                    });
                },
                select: function (event, ui) {
                    var selectedItem = ui.item;
                    var search = {sourceTaxonScientificName: selectedItem.value, interactionType: 'preysOn'};
                    var callback = function (interactions) {
                        var resultDiv = document.getElementById('result');
                        $('.interaction').remove();
                        var distinctNames = {};
                        var counter = 0;
                        interactions.forEach(function (interaction) {
                            if (counter % 4 == 0) {
                                row = document.createElement('tr');
                                row.setAttribute('class', 'interaction');
                                resultDiv.appendChild(row);
                            }

                            var td = document.createElement('td');
                            td.setAttribute('class', interaction.target.name);
                            td.innerHTML = interaction.target.name;
                            row.appendChild(td);
                            distinctNames[interaction.target.name] = interaction.target.id;
                            counter += 1;
                        });
                        var textElem = document.createElement('p')
                        textElem.setAttribute('class', 'interaction');
                        var prefix = '<span class="' + selectedItem.label + '">' + selectedItem.label + '</span> eat ';
                        var message = textElem.innerHTML = '. . . plenty of things, and perhaps you can make this result even better by <a href="http://github.com/jhpoelen/eol-globi-data/wiki">submitting new dataset!</a></p>';
                        if (counter == 0) {
                            message =  '<p class="interaction">. . . nothing that we know of.  Perhaps you should <a href="http://github.com/jhpoelen/eol-globi-data/wiki">submit new dataset!</a></p>';
                        }
                        textElem.innerHTML = prefix + message;
                        document.getElementById('info').appendChild(textElem);

                        Object.keys(distinctNames).forEach(function (name) {
                            globi.globiData.findTaxonInfo(name, function (taxonInfo) {
                                var label = taxonInfo.scientificName;
                                if (taxonInfo.commonName !== null) {
                                    label = taxonInfo.commonName + ' (' + label + ')';
                                }
                                var label = '<td>' + label + '</td>';
                                if (taxonInfo.thumbnailURL) {
                                    label = '<a href="' + taxonInfo.infoURL + '"><table><tr><td>' + '<img src="' + taxonInfo.thumbnailURL + '"/></td></tr><caption align="bottom">' + label + '</caption></table></a>';
                                }
                                $('.' + taxonInfo.scientificName).html(label);
                            });
                        });

                    };
                    globi.globiData.findSpeciesInteractions(search, callback);

                }
            });
        });
    </script>
</head>
<body>
<div class="ui-widget">
    <p>What do
    <td><input class="tags" autocomplete="off"/></td>
    eat?</p>
    <div id="info"></div>
    <table id="result">
    </table>
</div>
</body>
</html>
